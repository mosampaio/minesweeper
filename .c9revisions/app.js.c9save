{"ts":1350302015908,"silentsave":true,"restoring":false,"patch":[[{"diffs":[[1,"var cookie = require('cookie');\nvar express = require('express');\nvar http = require('http');\nvar app = express();\nvar MongoStore = require('connect-mongo')(express);\nvar mongo = require('mongoskin');\nvar conn = mongo.db('mongodb://minesweeper:1234@alex.mongohq.com:10076/minesweeper', {safe:true});\nvar server = http.createServer(app);\nvar io = require('socket.io').listen(server);\n//var store = new express.session.MemoryStore({reapInterval: 60000 * 10});\nvar conf = {\n  db: {\n    db: 'minesweeper',\n    host: 'alex.mongohq.com',\n    port: 10076,\n    username: 'minesweeper', // optional\n    password: '1234', // optional\n    collection: 'sessions' // optional, default: sessions\n  },\n  secret: 'foobar'\n};\nvar store = new MongoStore(conf.db)\nserver.listen(process.env.PORT, process.env.IP);\n\n\napp.use(express.bodyParser());\napp.use(express.cookieParser());\napp.use(express.session({store: store, secret:'foobar', key: 'express.sid', maxAge: new Date(Date.now() + 3600000)}));\napp.use('/static', express.static(__dirname + '/public'));\n\napp.get('/', function(req, res){\n    console.log('email : ' + req.session.email);\n    if (req.session.logged) {\n      res.sendfile(__dirname + '/public/home.html');\n    } else {\n      res.sendfile(__dirname + '/public/login.html');\n    }\n});\n\napp.post('/login/', function(req, res){\n    conn.collection('user').findOne({email: req.param('email', null)}, function(err, item){\n        if (err) res.sendfile(__dirname + '/public/login.html');\n        \n        req.session.email = req.param('email', null);\n        req.session.logged = true;\n        res.redirect('http://minesweeper.mosampaio.c9.io/');\n    });\n    \n});\n\napp.get('/users/connected/', function(req, res){\n    conn.collection('sessions').find().toArray(function(err, items){\n        if (err) { console.dir(err); }\n        var usersConnected = [];\n        for (var i in items) {\n            var session = JSON.parse(items[i].session);\n            if (session.logged) usersConnected.push(session.email);\n        }\n        var users = {usersConnected: usersConnected};\n        res.writeHead(200, { 'Content-Type': 'application/json' }); \n        res.write(JSON.stringify(users));\n        res.end();\n    });\n    \n\n});\n\n\nio.set('authorization', function (data, accept) {\n  if (data.headers.cookie) {\n    // Whatever you put in the data object will be available in socket.handshake later on in connection event handler\n    data.cookie = cookie.parse(data.headers.cookie);\n    data.sessionID = data.cookie['express.sid'].substring(2, 26);\n    //console.dir(data);\n    accept(null, true);\n  } else {\n    accept('No cookie transmitted.', false);\n  }\n});\n\nio.sockets.on('connection', function (socket) {\n  var sid = socket.handshake.sessionID;\n  console.log('A socket with sessionID ' + sid + ' connected!');\n  store.get(sid, function(error, session) {\n      socket.broadcast.emit('message', {type: 'broadcast', email: session.email});\n  });\n  \n  socket.on('message', function() { \n      console.log('###store get sid : ' + sid); \n      store.get(sid, function(error, session) {\n        console.log(session);\n      });\n      \n      \n  });\n  socket.on('disconnect', function () { console.log('disconnected'); });\n});"]],"start1":0,"start2":0,"length1":0,"length2":3204}]],"length":3204}
{"contributors":[],"silentsave":false,"ts":1350305649816,"patch":[[{"diffs":[[0,"onf.db)\n"],[1,"//"],[0,"server.l"]],"start1":737,"start2":737,"length1":16,"length2":18},{"diffs":[[0,"nv.IP);\n"],[1,"server.list(process.env.C9_PORT, '0.0.0.0');\n"],[0,"\n\napp.us"]],"start1":788,"start2":788,"length1":16,"length2":61}]],"length":3251,"saved":false}
{"ts":1350305661077,"patch":[[{"diffs":[[0,"ver.list"],[1,"en"],[0,"(process"]],"start1":799,"start2":799,"length1":16,"length2":18}]],"length":3253,"saved":false}
{"ts":1350305683009,"patch":[[{"diffs":[[0,"onf.db)\n"],[-1,"//"],[0,"server.l"]],"start1":737,"start2":737,"length1":18,"length2":16},{"diffs":[[0,"nv.IP);\n"],[1,"//"],[0,"server.l"]],"start1":786,"start2":786,"length1":16,"length2":18}]],"length":3253,"saved":false}
{"ts":1350305696788,"patch":[[{"diffs":[[0,"r(app);\n"],[1,"server.listen(process.env.PORT, process.env.IP);\n"],[0,"var io ="]],"start1":329,"start2":329,"length1":16,"length2":65},{"diffs":[[0,"db)\n"],[-1,"server.listen(process.env.PORT, process.env.IP);\n"],[0,"//se"]],"start1":790,"start2":790,"length1":57,"length2":8}]],"length":3253,"saved":false}
{"ts":1350305711992,"patch":[[{"diffs":[[0,"p);\n"],[-1,"server.listen(process.env.PORT, process.env.IP);\n"],[0,"var "]],"start1":333,"start2":333,"length1":57,"length2":8},{"diffs":[[0,"onf.db)\n"],[-1,"//"],[0,"server.l"]],"start1":737,"start2":737,"length1":18,"length2":16},{"diffs":[[0,"env."],[-1,"C9_"],[0,"PORT, "],[-1,"'0.0.0.0'"],[1,"process.env.IP"],[0,");\n\n"]],"start1":767,"start2":767,"length1":26,"length2":28}]],"length":3204,"saved":false}
{"ts":1350314612572,"patch":[[{"diffs":[[0,"unction("],[1,"msg"],[0,") { \n   "]],"start1":2958,"start2":2958,"length1":16,"length2":19}]],"length":3207,"saved":false}
{"ts":1350314633250,"patch":[[{"diffs":[[0,"g) { \n      "],[1,"console.dir(msg);\n      //"],[0,"console.log("]],"start1":2968,"start2":2968,"length1":24,"length2":50},{"diffs":[[0," \n      "],[1,"//"],[0,"store.ge"]],"start1":3047,"start2":3047,"length1":16,"length2":18},{"diffs":[[0,"on) {\n      "],[-1,"  "],[1,"//"],[0,"console.log("]],"start1":3093,"start2":3093,"length1":26,"length2":26},{"diffs":[[0,"ion);\n      "],[1,"//"],[0,"});\n      \n "]],"start1":3123,"start2":3123,"length1":24,"length2":26}]],"length":3237,"saved":false}
{"ts":1350314727956,"patch":[[{"diffs":[[0,"console."],[-1,"dir"],[1,"log"],[0,"(msg);\n "]],"start1":2980,"start2":2980,"length1":19,"length2":19}]],"length":3237,"saved":false}
{"ts":1350314737815,"patch":[[{"diffs":[[0,"g(msg);\n"],[1,"      console.log(msg.type);\n"],[0,"      //"]],"start1":2990,"start2":2990,"length1":16,"length2":45}]],"length":3266,"saved":false}
{"ts":1350314843853,"patch":[[{"diffs":[[0,"g);\n"],[-1,"      console.log(msg.type);\n"],[0,"    "]],"start1":2994,"start2":2994,"length1":37,"length2":8},{"diffs":[[0," ' + sid); \n"],[1,""],[0,"      //stor"]],"start1":3037,"start2":3037,"length1":24,"length2":24},{"diffs":[[0,"//});\n  "],[-1,"    \n      "],[1,"});\n  socket.on('challenge', function(msg) { \n      console.log(msg);\n      //console.log('###store get sid : ' + sid); \n      //store.get(sid, function(error, session) {\n      //console.log(session);\n      //});"],[0,"\n  });\n "]],"start1":3135,"start2":3135,"length1":27,"length2":228}]],"length":3438,"saved":false}
{"ts":1350314880423,"patch":[[{"diffs":[[0,"enge', function("],[-1,"msg"],[1,"data"],[0,") { \n      conso"]],"start1":3165,"start2":3165,"length1":35,"length2":36},{"diffs":[[0," \n      console."],[-1,"log(msg"],[1,"dir(data"],[0,");\n      //conso"]],"start1":3188,"start2":3188,"length1":39,"length2":40}]],"length":3440,"saved":false}
{"ts":1350315062131,"patch":[[{"diffs":[[0,"unction("],[-1,"msg"],[0,") { \n   "]],"start1":2958,"start2":2958,"length1":19,"length2":16},{"diffs":[[0,"    "],[-1,"console.log(msg);"],[0,"\n      "],[-1,"//"],[0,"cons"]],"start1":2973,"start2":2973,"length1":34,"length2":15},{"diffs":[[0," + sid); \n      "],[-1,"//"],[0,"store.get(sid, f"]],"start1":3017,"start2":3017,"length1":34,"length2":32},{"diffs":[[0,"ession) {\n      "],[-1,"//"],[0,"console.log(sess"]],"start1":3065,"start2":3065,"length1":34,"length2":32},{"diffs":[[0,"session);\n      "],[-1,"//"],[0,"});\n  });\n  sock"]],"start1":3093,"start2":3093,"length1":34,"length2":32}]],"length":3412,"saved":false}
{"contributors":[],"silentsave":false,"ts":1350324258027,"patch":[[{"diffs":[[0,"    console."],[-1,"dir"],[1,"log"],[0,"(data"],[1,".to"],[0,");\n      //c"]],"start1":3164,"start2":3164,"length1":32,"length2":35}]],"length":3415,"saved":false}
{"contributors":[],"silentsave":false,"ts":1350330602907,"patch":[[{"diffs":[[0," }\n});\n\n"],[1,"var clients = {};\n\n"],[0,"io.socke"]],"start1":2637,"start2":2637,"length1":16,"length2":35},{"diffs":[[0,"sionID;\n"],[1,"  clientes[sid] = socket;\n"],[0,"  consol"]],"start1":2744,"start2":2744,"length1":16,"length2":42}]],"length":3460,"saved":false}
{"ts":1350330605919,"patch":[[{"diffs":[[0,"  client"],[-1,"e"],[0,"s[sid] ="]],"start1":2752,"start2":2752,"length1":17,"length2":16}]],"length":3459,"saved":false}
{"ts":1350330660723,"patch":[[{"diffs":[[0,"ID;\n"],[-1,"  clients[sid] = socket;\n"],[0,"  co"]],"start1":2748,"start2":2748,"length1":33,"length2":8},{"diffs":[[0,"on.email});\n"],[1,"      \n      clients[session.email] = socket;\n"],[0,"  });\n  \n  s"]],"start1":2932,"start2":2932,"length1":24,"length2":70},{"diffs":[[0,"ta.to);\n"],[1,"      clients\n"],[0,"      //"]],"start1":3247,"start2":3247,"length1":16,"length2":30}]],"length":3494,"saved":false}
{"ts":1350330728788,"patch":[[{"diffs":[[0," clients"],[1,"[session].emit('message', 'aaaaaaaaaaaaaaaaa');"],[0,"\n      /"]],"start1":3260,"start2":3260,"length1":16,"length2":63}]],"length":3541,"saved":false}
{"ts":1350330734925,"patch":[[{"diffs":[[0,"clients["],[-1,"session"],[1,"data.to"],[0,"].emit('"]],"start1":3261,"start2":3261,"length1":23,"length2":23}]],"length":3541,"saved":false}
{"ts":1350332238890,"patch":[[{"diffs":[[0,"it('"],[-1,"message', 'aaaaaaaaaaaaaaaaa'"],[1,"challenge', {from: data.from}"],[0,");\n "]],"start1":3280,"start2":3280,"length1":37,"length2":37}]],"length":3541,"saved":false}
{"ts":1350332357230,"patch":[[{"diffs":[[0,"    "],[-1,"clients[data.to].emit('challenge', {from: data.from});\n      //console.log('###store get sid : ' + sid); \n      //store.get(sid, function(error, session) {\n      //console.log(session"],[1,"store.get(sid, function(error, session) {\n        clients[data.to].emit('challenge', {from: session.email}"],[0,");\n "]],"start1":3257,"start2":3257,"length1":191,"length2":114},{"diffs":[[0,";\n      "],[-1,"//"],[0,"});\n  })"]],"start1":3368,"start2":3368,"length1":18,"length2":16}]],"length":3462,"saved":false}
{"ts":1350332953328,"patch":[[{"diffs":[[0,"      });\n  });\n"],[1,"  \n"],[0,"  socket.on('cha"]],"start1":3168,"start2":3168,"length1":32,"length2":35}]],"length":3465,"saved":false}
{"ts":1350333000603,"patch":[[{"diffs":[[0,"it('"],[-1,"message', {type: 'broadcast"],[1,"joined"],[0,"', "],[1,"{"],[0,"emai"]],"start1":2886,"start2":2886,"length1":38,"length2":18}]],"length":3445,"saved":false}
{"ts":1350333077868,"patch":[[{"diffs":[[0,"on) {\n      "],[1,"  "],[0,"console.log("]],"start1":3114,"start2":3114,"length1":24,"length2":26}]],"length":3447,"saved":false}
{"ts":1350334554696,"patch":[[{"diffs":[[0,") {\n    "],[-1,"  "],[0,"socket.b"]],"start1":2857,"start2":2857,"length1":18,"length2":16},{"diffs":[[0,"mail});\n"],[-1,"      \n  "],[0,"    clie"]],"start1":2914,"start2":2914,"length1":25,"length2":16}]],"length":3436,"saved":false}
{"ts":1350334562237,"patch":[[{"diffs":[[0,"on() { \n"],[-1,"      \n"],[0,"      co"]],"start1":2997,"start2":2997,"length1":23,"length2":16}]],"length":3429,"saved":false}
